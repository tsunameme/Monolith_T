# rams parent ship into the closest shuttle with a powered shuttle console
- type: htnCompound
  id: RammerShuttleCompound
  branches:
  - tasks:
    - !type:HTNPrimitiveTask
      operator: !type:UtilityOperator
        proto: NearbyShuttleTargets
    - !type:HTNCompoundTask
      task: ShuttleRamCompound
    - !type:HTNCompoundTask
      task: ShuttleBackOffCompound

# same, but with leading
- type: htnCompound
  id: RammerShuttleSmartCompound
  branches:
  - tasks:
    - !type:HTNPrimitiveTask
      operator: !type:UtilityOperator
        proto: NearbyShuttleTargets
    - !type:HTNCompoundTask
      task: ShuttleRamSmartCompound
    - !type:HTNCompoundTask
      task: ShuttleBackOffCompound

# same, but with leading
- type: htnCompound
  id: RammerShuttleSmartDodgingCompound
  branches:
  - tasks:
    - !type:HTNPrimitiveTask
      operator: !type:UtilityOperator
        proto: NearbyShuttleTargets
    - !type:HTNCompoundTask
      task: ShuttleRamSmartDodgingCompound
    - !type:HTNCompoundTask
      task: ShuttleBackOffCompound

# ram, but no collision evasion
- type: htnCompound
  id: RammerShuttleStraightCompound
  branches:
  - tasks:
    - !type:HTNPrimitiveTask
      operator: !type:UtilityOperator
        proto: NearbyShuttleTargets
    - !type:HTNCompoundTask
      task: ShuttleRamStraightCompound
    - !type:HTNCompoundTask
      task: ShuttleBackOffCompound

# approaches closest shuttle with parent ship
- type: htnCompound
  id: ApproacherShuttleCompound
  branches:
  - tasks:
    - !type:HTNPrimitiveTask
      operator: !type:UtilityOperator
        proto: NearbyShuttleTargets
    - !type:HTNCompoundTask
      task: ShuttleApproachCompound

- type: htnCompound
  id: AttackerShuttleCompound
  branches:
  - tasks:
    - !type:HTNPrimitiveTask
      operator: !type:UtilityOperator
        proto: NearbyShuttleTargets
    - !type:HTNCompoundTask
      task: ShuttleAttackCompound

- type: htnCompound
  id: AttackerShuttleSmartCompound
  branches:
  - tasks:
    - !type:HTNPrimitiveTask
      operator: !type:UtilityOperator
        proto: NearbyShuttleTargets
    - !type:HTNCompoundTask
      task: ShuttleAttackSmartCompound

- type: utilityQuery
  id: NearbyShuttleTargets
  query:
  - !type:NearbyHostileShuttlesQuery
    blacklist:
      tags:
      - ShuttleAIIgnore
  considerations:
  - !type:TargetInverseDistanceCon
    curve: !type:QuadraticCurve
      slope: 1
      exponent: 1
      yOffset: 0
      xOffset: 0

- type: htnCompound
  id: ShuttleRamCompound
  branches:
  - preconditions:
    - !type:KeyExistsPrecondition
      key: Target
    tasks:
    - !type:HTNPrimitiveTask
      operator: !type:ShipMoveToOperator
        shutdownState: TaskFinished
        removeKeyOnFinish: false
        inRangeMaxSpeed: null # there's no braking where we're going
        leadingEnabled: false # else it's too good
        targetKey: TargetCoordinates
      services:
      - !type:UtilityService
        id: TargetsService
        proto: NearbyShuttleTargets
        key: Target
        coordinatesKey: TargetCoordinates

- type: htnCompound
  id: ShuttleRamSmartCompound
  branches:
  - preconditions:
    - !type:KeyExistsPrecondition
      key: Target
    tasks:
    - !type:HTNPrimitiveTask
      operator: !type:ShipMoveToOperator
        shutdownState: TaskFinished
        removeKeyOnFinish: false
        inRangeMaxSpeed: null # there's no braking where we're going
        targetKey: TargetCoordinates
      services:
      - !type:UtilityService
        id: TargetsService
        proto: NearbyShuttleTargets
        key: Target
        coordinatesKey: TargetCoordinates

- type: htnCompound
  id: ShuttleRamSmartDodgingCompound
  branches:
  - preconditions:
    - !type:KeyExistsPrecondition
      key: Target
    tasks:
    - !type:HTNPrimitiveTask
      operator: !type:ShipMoveToOperator
        shutdownState: TaskFinished
        removeKeyOnFinish: false
        inRangeMaxSpeed: null # there's no braking where we're going
        targetKey: TargetCoordinates
        avoidProjectiles: true
      services:
      - !type:UtilityService
        id: TargetsService
        proto: NearbyShuttleTargets
        key: Target
        coordinatesKey: TargetCoordinates

- type: htnCompound
  id: ShuttleRamStraightCompound
  branches:
  - preconditions:
    - !type:KeyExistsPrecondition
      key: Target
    tasks:
    - !type:HTNPrimitiveTask
      operator: !type:ShipMoveToOperator
        shutdownState: TaskFinished
        removeKeyOnFinish: false
        inRangeMaxSpeed: null # there's no braking where we're going
        targetKey: TargetCoordinates
        avoidCollisions: false
        leadingEnabled: false
      services:
      - !type:UtilityService
        id: TargetsService
        proto: NearbyShuttleTargets
        key: Target
        coordinatesKey: TargetCoordinates

- type: htnCompound
  id: ShuttleBackOffCompound
  branches:
  - preconditions:
    - !type:KeyExistsPrecondition
      key: Target
    tasks:
    - !type:HTNPrimitiveTask
      operator: !type:ShipMoveToOperator
        shutdownState: TaskFinished
        removeKeyOnFinish: false
        finishOnCollide: false # we might be already collided
        inRangeMaxSpeed: null # just immediately finish once out of range
        leadingEnabled: false
        # be within 200-300m
        range: 300
        rangeTolerance: 100
        targetKey: TargetCoordinates

- type: htnCompound
  id: ShuttleApproachCompound
  branches:
  - preconditions:
    - !type:KeyExistsPrecondition
      key: TargetCoordinates
    tasks:
    - !type:HTNPrimitiveTask
      operator: !type:ShipMoveToOperator
        shutdownState: TaskFinished
        removeKeyOnFinish: false
        inRangeMaxSpeed: 0.1
        range: 250
        rangeTolerance: 50
        alwaysFaceTarget: true
        targetKey: TargetCoordinates
      services:
      - !type:UtilityService
        id: TargetsService
        proto: NearbyShuttleTargets
        key: Target
        coordinatesKey: TargetCoordinates

- type: htnCompound
  id: ShuttleAttackCompound
  branches:
  - preconditions:
    - !type:KeyExistsPrecondition
      key: TargetCoordinates
    tasks:
    - !type:HTNPrimitiveTask
      operator: !type:ShipMoveToOperator
        shutdownState: PlanFinished
        removeKeyOnFinish: false
        alwaysFaceTarget: true
        inRangeMaxSpeed: null # orbit at top velocity
        range: 850
        rangeTolerance: 150
        targetKey: TargetCoordinates
        mode: Orbit
    - !type:HTNPrimitiveTask
      operator: !type:ShipFireGunsOperator
        shutdownState: TaskFinished
        removeKeyOnFinish: false
        leadingAccuracy: 0.4 # stupid
        targetKey: TargetCoordinates
      services:
      - !type:UtilityService
        id: TargetsService
        proto: NearbyShuttleTargets
        key: Target
        coordinatesKey: TargetCoordinates

# hardest possible attacker AI
- type: htnCompound
  id: ShuttleAttackSmartCompound
  branches:
  - preconditions:
    - !type:KeyExistsPrecondition
      key: TargetCoordinates
    tasks:
    - !type:HTNPrimitiveTask
      operator: !type:ShipMoveToOperator
        shutdownState: PlanFinished
        removeKeyOnFinish: false
        alwaysFaceTarget: true
        inRangeMaxSpeed: null # orbit at top velocity
        range: 850
        rangeTolerance: 150
        avoidProjectiles: true
        targetKey: TargetCoordinates
        mode: Orbit
    - !type:HTNPrimitiveTask
      operator: !type:ShipFireGunsOperator
        shutdownState: TaskFinished
        removeKeyOnFinish: false
        leadingAccuracy: 1
        targetKey: TargetCoordinates
      services:
      - !type:UtilityService
        id: TargetsService
        proto: NearbyShuttleTargets
        key: Target
        coordinatesKey: TargetCoordinates
