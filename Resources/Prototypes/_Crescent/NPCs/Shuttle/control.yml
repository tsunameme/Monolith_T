- type: entity
  parent: [ BaseMachinePowered ]
  id: DroneController
  name: drone control server
  description: Pilots the drone it's on, if controlled by a drone control console.
  components:
  - type: Sprite
    sprite: Structures/Machines/telecomms.rsi
    snapCardinals: true
    layers:
    - state: icon
    - state: unlit
      shader: unshaded
      map: ["enum.PowerDeviceVisualLayers.Powered"]
    - state: panel
      map: ["enum.WiresVisualLayers.MaintenancePanel"]
  - type: GenericVisualizer
    visuals:
      enum.PowerDeviceVisuals.Powered:
        enum.PowerDeviceVisualLayers.Powered:
          True: { visible: true }
          False: { visible: false }
  - type: Appearance
  - type: WiresVisuals
  - type: Physics
    bodyType: Static
  - type: Fixtures
    fixtures:
      fix1:
        shape:
          !type:PhysShapeAabb
          bounds: "-0.4,-0.4,0.4,0.4"
        density: 190
        mask:
        - MachineMask
        layer:
        - MachineLayer
  - type: Destructible
    thresholds:
    - trigger:
        !type:DamageTrigger
        damage: 100
      behaviors:
      - !type:PlaySoundBehavior
        sound:
          collection: MetalBreak
      - !type:ChangeConstructionNodeBehavior
        node: machineFrame
      - !type:DoActsBehavior
        acts: ["Destruction"]
  - type: WiresPanel
  - type: Transform
    anchored: true
  - type: Pullable
  - type: DroneControl
  - type: ShipNpcTarget
  - type: HTN
    sleepPlayerCheckRangeOverride: 100000 # 100k aka basically never sleep
    rootTask:
      task: DroneCompound
  - type: WorldLoader
    radius: 256
  - type: DeviceNetwork
    deviceNetId: Wireless
    receiveFrequencyId: DroneControl
  - type: WirelessNetworkConnection
    range: 100000 # keep same as sleep range

- type: entity
  parent: BaseComputerAiAccess
  id: ComputerDroneControl
  name: drone control console
  description: A console that lets you control linked drones.
  components:
  - type: Sprite
    layers:
    - map: ["computerLayerBody"]
      state: computer
    - map: ["computerLayerKeyboard"]
      state: generic_keyboard
    - map: ["computerLayerScreen"]
      state: shuttle
    - map: ["computerLayerKeys"]
      state: generic_keys
  - type: Computer
    board: DroneControlCircuitboard
  - type: DroneControlConsole
    maxOrderRadius: 4000
  - type: ActivatableUI
    key: enum.DroneConsoleUiKey.Key
  - type: UserInterface
    interfaces:
      enum.DroneConsoleUiKey.Key:
        type: DroneConsoleBoundUserInterface
  - type: RadarConsole
  - type: WorldLoader
    radius: 256
  - type: DeviceNetwork
    deviceNetId: Wireless
    transmitFrequencyId: DroneControl
  - type: WirelessNetworkConnection
    range: 100000
  - type: DeviceList

- type: entity
  parent: ComputerDroneControl
  id: ComputerDroneControlStation
  name: station drone control console
  description: A console that lets you control linked drones.
  components:
  - type: DroneControlConsole
    maxOrderRadius: null # infinite

- type: deviceFrequency
  id: DroneControl
  name: device-frequency-prototype-name-drone-control
  frequency: 3547

- type: entity
  parent: BaseComputerCircuitboard
  id: DroneControlCircuitboard
  name: drone control console board
  description: A computer printed circuit board for a drone control console.
  components:
    - type: ComputerBoard
      prototype: ComputerDroneControl

- type: htnCompound
  id: DroneCompound
  branches:
  - preconditions:
    - !type:KeyEqualsPrecondition
      key: DroneCommand
      value: drone_cmd_move
    tasks:
    - !type:HTNCompoundTask
      task: DroneMoveCompound
  - preconditions:
    - !type:KeyEqualsPrecondition
      key: DroneCommand
      value: drone_cmd_target
    tasks:
    - !type:HTNCompoundTask
      task: DroneAttackCompound

- type: htnCompound
  id: DroneMoveCompound
  branches:
  - tasks:
    - !type:HTNPrimitiveTask
      operator: !type:ShipMoveToOperator
        shutdownState: TaskFinished
        removeKeyOnFinish: true
        inRangeMaxSpeed: 0.1
        range: 15
        leadingEnabled: false # nothing to lead
        alwaysFaceTarget: true
        targetKey: DroneTarget

- type: htnCompound
  id: DroneAttackCompound
  branches:
  - tasks:
    - !type:HTNPrimitiveTask
      operator: !type:ShipMoveToOperator
        shutdownState: PlanFinished
        removeKeyOnFinish: false
        alwaysFaceTarget: true
        inRangeMaxSpeed: 1
        range: 250
        rangeTolerance: 50
        targetKey: DroneTarget
    - !type:HTNPrimitiveTask
      operator: !type:ShipFireGunsOperator
        shutdownState: TaskFinished
        removeKeyOnFinish: true
        leadingAccuracy: 0.4
        targetKey: DroneTarget
